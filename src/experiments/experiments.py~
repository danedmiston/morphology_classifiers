from sklearn.metrics import f1_score
import numpy as np
import pandas as pd
from sklearn.linear_model import LogisticRegression
from utils.loader import *
from sklearn.cluster import *
from utils.book_keeping import *
from sklearn.model_selection import train_test_split
from torch import nn
import torch.nn.functional as F
from skorch import NeuralNetClassifier
from skorch.callbacks import Checkpoint, EarlyStopping


class Experiment():
    def __init__(self, language, feature):
        self.language = language
        self.feature = feature

        self.num_classes = len(Features[self.language][feature])
        self.point_clouds = load_point_clouds(language=self.language, feature=self.feature)

        self.f2l, self.l2f = feat2label(self.language, self.feature)

class Clusterer(Experiment):
    def __init__(self, language, feature, method=KMeans):
        super().__init__(language, feature)
        self.method = method
        

    def cluster_by_layer(self, layer, average="weighted"):
        clustering = self.method(n_clusters=self.num_classes, random_state=42)
        clustering.fit(np.stack(self.point_clouds[layer]["Vector"].values, axis=0))
        ground_truth = [self.f2l[list(item)[0]] for item in self.point_clouds[layer]["Class"]]
        return(f1_score(ground_truth, clustering.labels_, average=average))

    def run_cluster_experiment(self, average="weighted"):
        results = []
        with open(Cluster_Results[self.language] + self.feature + ".txt", "w") as fout:
            for i in range(13):
                result = self.cluster_by_layer(i, average=average)
                results.append(result)
                print(result, "\n\n")

                fout.write("Result for layer " + str(i) + ": " + str(result) + "\n\n")
            print("Average result:", np.mean(results))
            fout.write("Average result for all layers:" + str(np.mean(results)))


class Linear(Experiment):
    def __init__(self, language, feature):
        super().__init__(language, feature)

        self.train_set = {}
        self.test_set = {}

        print("Preparing data sets...")
        

        for layer in range(13):
            
            self.train_set[layer] = {}
            self.test_set[layer] = {}

            vectors = self.point_clouds[layer]["Vector"]
            ground_truth = [self.f2l[list(item)[0]] for item in self.point_clouds[layer]["Class"]]
            X_train, X_test, y_train, y_test = train_test_split(vectors, ground_truth,
                                                                test_size=0.15, random_state=42)
            self.train_set[layer]["X"] = X_train
            self.train_set[layer]["y"] = y_train

            self.test_set[layer]["X"] = X_test
            self.test_set[layer]["y"] = y_test

            
    def linear_by_layer(self, layer, average="weighted"):
        # Training

        X_train = np.stack(self.train_set[layer]["X"].values, axis=0)
        y_train = np.stack(self.train_set[layer]["y"], axis=0)
        clf = LogisticRegression(random_state=42, max_iter=2500)
        clf.fit(X_train, y_train)

        # Testing

        X_test = np.stack(self.test_set[layer]["X"].values, axis=0)
        y_test = np.stack(self.test_set[layer]["y"], axis=0)
        y_hat = clf.predict(X_test)
        return(f1_score(y_test, y_hat, average=average))

    def run_linear_experiment(self, average="weighted"):
        results = []
        with open(Linear_Results[self.language] + self.feature + ".txt", "w") as fout:
            for i in range(13):
                result = self.linear_by_layer(i, average=average)
                results.append(result)
                print(result, "\n\n")
                fout.write("Result for layer " + str(i) + ": " + str(result) + "\n\n")
            print("Average result:", np.mean(results))
            fout.write("Average result for all layers: " + str(np.mean(results)))


class NonLinear(Linear):
    def __init__(self, language, feature, hidden=768, activation=F.tanh):
        super().__init__(language, feature)

        self.hidden = hidden
        self.activation = activation

        class TwoLayerNN(nn.Module):
            def __init__(self, hidden, num_classes, activation):
                super(TwoLayerNN, self).__init__()

                self.hidden = hidden
                self.num_classes = num_classes
                self.activation = activation

            
                self.Layer1 = nn.Linear(768, self.hidden, bias=True)
                self.Output = nn.Linear(self.hidden, self.num_classes, bias=True)

            def forward(self, X):
                z1 = self.Layer1(X)
                a1 = self.activation(z1)
                z2 = self.Output(a1)
                y_hat = F.softmax(z2)
                return(y_hat)       

        self.monitor = lambda net: all(net.history[-1, ("train_loss_best", "valid_loss_best")])
        self.net = NeuralNetClassifier(module=TwoLayerNN,
                                       module__hidden=self.hidden,
                                       module__num_classes=self.num_classes,
                                       module__activation=self.activation,
                                       max_epochs=2500,
                                       lr=0.1, iterator_train__shuffle=True,
                                       callbacks=[Checkpoint(monitor=self.monitor),
                                                  EarlyStopping()])
        
    def nonlinear_by_layer(self, layer, average="weighted"):
        X_train = np.stack(self.train_set[layer]["X"].values, axis=0)
        y_train = np.stack(self.train_set[layer]["y"], axis=0)
        self.net.fit(X_train, y_train)
        X_test = np.stack(self.test_set[layer]["X"].values, axis=0)
        y_test = np.stack(self.test_set[layer]["y"], axis=0)
        y_hat = self.net.predict(X_test)
        return(f1_score(y_test, y_hat, average=average))

    
    def run_nonlinear_experiment(self, average="weighted"):
        results = []
        with open(NonLinear_Results[self.language] + self.feature + ".txt", "w") as fout:
            for i in range(13):
                result = self.nonlinear_by_layer(i, average=average)
                results.append(result)
                print(result, "\n\n")
                fout.write("Result for layer " + str(i) + ": " + str(result) + "\n\n")
            print("Average result:", np.mean(results))
            fout.write("Average result for all layers: " + str(np.mean(results)))


    
    
